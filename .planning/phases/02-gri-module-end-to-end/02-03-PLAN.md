---
phase: 02-gri-module-end-to-end
plan: 03
type: execute
wave: 3
depends_on:
  - "02-02"
files_modified:
  - src/components/gri/GriPdfDocument.tsx
  - src/components/gri/GriForm.tsx
  - public/fonts/Inter-Regular.ttf
  - public/fonts/Inter-Bold.ttf
  - public/fonts/Inter-SemiBold.ttf
autonomous: true
requirements:
  - OUT-01

must_haves:
  truths:
    - "Student can download a professionally formatted PDF report from the GRI assessment page"
    - "PDF has a corporate-styled cover page with organization name, date, and platform branding"
    - "PDF body contains all applicable GRI disclosures with filled values or 'Not reported' for unfilled ones"
    - "PDF ends with a GRI Content Index mapping each disclosure to its reported status"
    - "PDF export works even with validation errors, showing a warning banner listing incomplete sections"
  artifacts:
    - path: "src/components/gri/GriPdfDocument.tsx"
      provides: "Complete @react-pdf/renderer Document for GRI sustainability report"
      exports: ["GriPdfDocument"]
    - path: "public/fonts/Inter-Regular.ttf"
      provides: "Inter Regular font file for PDF rendering"
    - path: "public/fonts/Inter-Bold.ttf"
      provides: "Inter Bold font file for PDF rendering"
  key_links:
    - from: "src/components/gri/GriPdfDocument.tsx"
      to: "@react-pdf/renderer"
      via: "Document/Page/View/Text components with StyleSheet and Font.register"
      pattern: "Document|Page|View|Text|StyleSheet|Font\\.register"
    - from: "src/components/gri/GriForm.tsx"
      to: "src/components/gri/GriPdfDocument.tsx"
      via: "PDFDownloadLink passing form data and materialTopics to GriPdfDocument"
      pattern: "PDFDownloadLink.*GriPdfDocument"
    - from: "src/components/gri/GriPdfDocument.tsx"
      to: "src/schemas/gri.ts"
      via: "Imports GriFormData type and griDisclosures metadata for report rendering"
      pattern: "GriFormData|griDisclosures"
---

<objective>
Add PDF export to the GRI assessment, generating a professionally formatted sustainability report that students can download.

Purpose: This completes the GRI assessment flow (OUT-01). Students fill the form, see the live preview, then download a corporate-quality PDF report matching real GRI reporting conventions. The PDF includes a cover page, all disclosures (filled or marked "Not reported"), and a GRI Content Index -- proving the full end-to-end pattern for Phase 3 replication.

Output: GriPdfDocument component using @react-pdf/renderer, Inter font files for PDF rendering, and a "Download PDF Report" button integrated into the GRI form toolbar.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-gri-module-end-to-end/02-RESEARCH.md
@.planning/phases/02-gri-module-end-to-end/02-01-SUMMARY.md
@.planning/phases/02-gri-module-end-to-end/02-02-SUMMARY.md
@src/schemas/gri.ts
@src/components/gri/GriForm.tsx
@src/components/gri/GriPdfDocument.tsx
@src/index.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GriPdfDocument with corporate report styling and Content Index</name>
  <files>
    src/components/gri/GriPdfDocument.tsx
    public/fonts/Inter-Regular.ttf
    public/fonts/Inter-Bold.ttf
    public/fonts/Inter-SemiBold.ttf
  </files>
  <action>
    **Step 1: Download Inter font files for @react-pdf/renderer**

    @react-pdf/renderer cannot use variable fonts (WOFF2). It needs static .ttf files. Per research Pitfall 3:

    Download Inter .ttf files (Regular, SemiBold, Bold) and place in `public/fonts/`:
    ```bash
    mkdir -p public/fonts
    # Download from Google Fonts API or fontsource
    curl -L "https://fonts.gstatic.com/s/inter/v18/UcCO3FwrK3iLTeHuS_nVMrMxCp50SjIw2boKoduKmMEVuLyfAZ9hjQ.ttf" -o public/fonts/Inter-Regular.ttf
    curl -L "https://fonts.gstatic.com/s/inter/v18/UcCO3FwrK3iLTeHuS_nVMrMxCp50SjIw2boKoduKmMEVuGKYAZ9hjQ.ttf" -o public/fonts/Inter-SemiBold.ttf
    curl -L "https://fonts.gstatic.com/s/inter/v18/UcCO3FwrK3iLTeHuS_nVMrMxCp50SjIw2boKoduKmMEVuFuYAZ9hjQ.ttf" -o public/fonts/Inter-Bold.ttf
    ```

    If these URLs are stale, download Inter TTF files from https://github.com/rsms/inter/releases (the official Inter repository) or from Google Fonts. The exact source doesn't matter -- we need static .ttf files for Regular (400), SemiBold (600), and Bold (700) weights.

    **Step 2: Create `src/components/gri/GriPdfDocument.tsx`**

    A standalone @react-pdf/renderer Document component. This is completely separate from the HTML preview (GriReportPreview.tsx) -- they share data types but NOT component code, per the research anti-pattern warning.

    **Font registration:**
    ```typescript
    import { Font } from "@react-pdf/renderer";

    Font.register({
      family: "Inter",
      fonts: [
        { src: "/fonts/Inter-Regular.ttf", fontWeight: 400 },
        { src: "/fonts/Inter-SemiBold.ttf", fontWeight: 600 },
        { src: "/fonts/Inter-Bold.ttf", fontWeight: 700 },
      ],
    });
    ```

    **Props interface:**
    ```typescript
    interface GriPdfDocumentProps {
      data: GriFormData;
      materialTopics: string[];
      validationErrors?: string[];  // from form validation -- shown in warning banner
    }
    ```

    **Document structure:**

    *Cover Page:*
    - Full-page cover with centered content
    - Large title: "GRI Sustainability Report"
    - Organization name (from data.gri2.disclosure_2_1 if filled, otherwise "Organization Name")
    - Reporting period (from data.gri2.disclosure_2_3 if filled, otherwise "Reporting Period")
    - Date: current date formatted
    - Platform branding: small text at bottom "Generated with Sustainability Assessment Platform"
    - Use the forest/earth color palette for branding elements (approximate oklch values in RGB for PDF: primary green ~#2d5016, earth accent ~#8b6914)

    *Report Body Pages:*
    - Header on each page: "GRI Sustainability Report" (small, top-right) + page number (bottom-center)
    - If validationErrors present: warning banner at top of first body page: "This report contains incomplete or invalid sections: [list of section names]"

    Section: GRI 2 - General Disclosures
    - Subsection headings (The Organization, Activities and Workers, etc.)
    - Each disclosure: code in small gray text, title in bold, then value text below
    - If disclosure not filled: show "Not reported" in italic gray (per user decision: all applicable disclosures included, unfilled marked "Not reported")

    Section: GRI 3 - Material Topics
    - Same pattern as GRI 2
    - Include the list of material topics selected

    Section: Topic Standards (only for material topics)
    - For each material topic (in numeric order): section header, then disclosures
    - Same reported/not-reported pattern

    *GRI Content Index (last pages):*
    - Title: "GRI Content Index"
    - Table with columns: GRI Standard | Disclosure | Title | Status
    - Status: "Reported" (green text) or "Not reported" (gray text)
    - Lists ALL applicable disclosures (GRI 2, GRI 3, and all material Topic Standards)
    - Per research Pitfall 5: place Content Index at END of document. For page references, use section names rather than exact page numbers (standard GRI practice for generated reports).

    **Styling (StyleSheet.create):**
    ```typescript
    const styles = StyleSheet.create({
      page: { padding: 40, fontFamily: "Inter", fontSize: 10, lineHeight: 1.5 },
      coverPage: { padding: 60, justifyContent: "center", alignItems: "center" },
      coverTitle: { fontSize: 32, fontWeight: 700, marginBottom: 16 },
      coverOrg: { fontSize: 18, fontWeight: 600, marginBottom: 8 },
      coverDate: { fontSize: 12, color: "#666", marginBottom: 40 },
      coverBranding: { fontSize: 8, color: "#999", position: "absolute", bottom: 40 },
      header: { fontSize: 8, color: "#666", textAlign: "right", marginBottom: 20 },
      footer: { fontSize: 8, color: "#666", textAlign: "center", position: "absolute", bottom: 30, left: 40, right: 40 },
      sectionTitle: { fontSize: 16, fontWeight: 700, marginTop: 20, marginBottom: 10, borderBottomWidth: 1, borderBottomColor: "#e5e7eb", paddingBottom: 6 },
      subsectionTitle: { fontSize: 12, fontWeight: 600, marginTop: 14, marginBottom: 6, color: "#374151" },
      disclosure: { marginBottom: 10 },
      disclosureCode: { fontSize: 8, color: "#9ca3af", marginBottom: 2 },
      disclosureTitle: { fontSize: 10, fontWeight: 600, marginBottom: 3 },
      disclosureValue: { fontSize: 10, color: "#374151" },
      notReported: { fontSize: 10, color: "#9ca3af", fontStyle: "italic" },
      warningBanner: { backgroundColor: "#fef3c7", padding: 10, marginBottom: 16, borderRadius: 4 },
      warningText: { fontSize: 9, color: "#92400e" },
      contentIndexTable: { marginTop: 10 },
      tableRow: { flexDirection: "row", borderBottomWidth: 0.5, borderBottomColor: "#e5e7eb", paddingVertical: 4 },
      tableHeader: { flexDirection: "row", borderBottomWidth: 1, borderBottomColor: "#374151", paddingBottom: 6, marginBottom: 4 },
      tableCell: { fontSize: 9, flex: 1 },
      tableCellNarrow: { fontSize: 9, width: 80 },
      statusReported: { fontSize: 9, color: "#166534" },
      statusNotReported: { fontSize: 9, color: "#9ca3af", fontStyle: "italic" },
    });
    ```

    **Important:** @react-pdf/renderer uses its own View/Text/Page primitives -- NOT HTML divs. All content must use these primitives. The render function maps over griDisclosures from the schema to build the report body and Content Index programmatically.
  </action>
  <verify>
    <automated>npx tsc --noEmit 2>&1 | head -20</automated>
    <manual>Check that GriPdfDocument imports from @react-pdf/renderer (Document, Page, View, Text, StyleSheet, Font), registers Inter fonts, and renders cover page + body + Content Index.</manual>
  </verify>
  <done>
    - GriPdfDocument renders a multi-page PDF with: cover page, GRI 2 disclosures, GRI 3 disclosures, material Topic Standard disclosures, and Content Index
    - Cover page shows organization name, report title, date, and platform branding
    - Unfilled disclosures show "Not reported" in italic gray
    - Content Index lists all applicable disclosures with Reported/Not reported status
    - Validation warning banner appears when validationErrors prop is non-empty
    - Inter font registered from public/fonts/ TTF files
    - TypeScript compiles with zero errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate PDF export button into GRI form with PDFDownloadLink</name>
  <files>
    src/components/gri/GriForm.tsx
  </files>
  <action>
    **Modify `src/components/gri/GriForm.tsx`** to add the PDF export button.

    Add to the form toolbar/header area (where the "Validate All" button lives from Plan 02):

    1. **Import PDFDownloadLink** from @react-pdf/renderer
    2. **Import GriPdfDocument** from ./GriPdfDocument

    3. **Get current form values for PDF:**
       Use `useWatch()` or `getValues()` to get current form data for the PDF document.
       - `getValues()` is better here because we only need data at the moment of PDF generation, not continuous subscription.
       - Also get materialTopics from form values.

    4. **Get validation errors for the PDF warning banner:**
       When the "Download PDF" button is clicked:
       - Run `trigger()` (full form validation) silently
       - Collect any error paths from formState.errors
       - Map error paths to section names for the warning banner
       - Pass these as `validationErrors` to GriPdfDocument
       - Per user decision: PDF export is allowed even with errors -- the warning banner in the PDF lists incomplete sections

    5. **Render PDFDownloadLink:**
       ```tsx
       <PDFDownloadLink
         document={
           <GriPdfDocument
             data={getValues()}
             materialTopics={getValues("materialTopics")}
             validationErrors={validationErrorSummary}
           />
         }
         fileName="gri-sustainability-report.pdf"
       >
         {({ loading }) => (
           <Button variant="default" disabled={loading}>
             {loading ? "Generating PDF..." : "Download PDF Report"}
           </Button>
         )}
       </PDFDownloadLink>
       ```

    6. **Toolbar layout:**
       The form toolbar (above the form content area, within the form panel) should have:
       - Left side: Active section title (e.g., "GRI 2: General Disclosures")
       - Right side: "Validate All" button + "Download PDF Report" button
       - Use flexbox justify-between with gap

    **Note on PDFDownloadLink behavior:**
    - PDFDownloadLink generates the PDF in the browser when clicked
    - It shows a loading state while generating
    - The document prop receives the current form values at click time
    - If the PDF is slow to generate (>2s), the loading state provides feedback
    - Consider wrapping PDFDownloadLink in a Suspense boundary if needed for lazy loading of @react-pdf/renderer
  </action>
  <verify>
    <automated>npm run build 2>&1 | tail -5</automated>
    <manual>
      1. Run `npm run dev`
      2. Navigate to /module/gri
      3. Fill in a few GRI 2 disclosures
      4. Select some material topics (e.g., GRI 305 Emissions)
      5. Click "Download PDF Report"
      6. Verify: PDF downloads with filename "gri-sustainability-report.pdf"
      7. Open PDF and verify: cover page with organization name, body with filled disclosures, "Not reported" for unfilled ones, Content Index at the end
      8. Try downloading with validation errors: verify warning banner appears in PDF
    </manual>
  </verify>
  <done>
    - "Download PDF Report" button appears in GRI form toolbar
    - Clicking generates and downloads a PDF named "gri-sustainability-report.pdf"
    - PDF contains all form data at the moment of download
    - PDF shows "Not reported" for unfilled disclosures
    - PDF includes warning banner when there are validation errors
    - Button shows "Generating PDF..." loading state during generation
    - Build succeeds with zero errors
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `npm run build` succeeds
2. `npx tsc --noEmit` passes
3. PDF download works from the GRI assessment page
4. PDF has cover page, body with disclosures, and Content Index
5. Unfilled disclosures marked "Not reported"
6. Validation errors produce warning banner in PDF
7. Inter font renders correctly in PDF (not fallback Times New Roman)
8. Full end-to-end flow works: fill form -> see preview -> download PDF
</verification>

<success_criteria>
- Students can download a professionally formatted GRI sustainability report PDF
- PDF matches corporate annual report conventions: cover page, headers/footers, professional typography
- PDF includes auto-generated GRI Content Index
- PDF export works regardless of validation state (with appropriate warnings)
- The full Phase 2 user story is complete: form -> preview -> PDF
</success_criteria>

<output>
After completion, create `.planning/phases/02-gri-module-end-to-end/02-03-SUMMARY.md`
</output>
