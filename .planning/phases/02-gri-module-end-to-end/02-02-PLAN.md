---
phase: 02-gri-module-end-to-end
plan: 02
type: execute
wave: 2
depends_on:
  - "02-01"
files_modified:
  - src/components/gri/GriForm.tsx
  - src/components/gri/GriSidebar.tsx
  - src/components/gri/GriUniversalSection.tsx
  - src/components/gri/GriMaterialTopics.tsx
  - src/components/gri/GriTopicSection.tsx
  - src/components/gri/GriAssessment.tsx
  - src/components/gri/GriReportPreview.tsx
  - src/pages/ModulePage.tsx
  - src/components/layout/AppLayout.tsx
  - src/components/ui/resizable.tsx
autonomous: true
requirements:
  - FORM-01
  - FORM-07

must_haves:
  truths:
    - "GRI form presents structured sections mirroring GRI Universal Standards (GRI 1, 2, 3 + Topic Standards) with correct disclosure labels and reference codes"
    - "Persistent sidebar lists all GRI sections and shows visual completion indicators per section"
    - "Students select material topics via checklist, and selected topics expand with disclosure fields"
    - "Live preview panel updates in real-time as the student types, rendering a framework-formatted report layout"
    - "Side-by-side resizable layout with draggable divider lets students adjust form/preview split"
    - "Empty/unfilled sections in preview show grayed-out placeholder text"
    - "Form and preview panels scroll independently"
    - "Form data persists to localStorage so students can close browser and resume"
    - "Validation runs on section navigation, not inline as student types"
  artifacts:
    - path: "src/components/gri/GriForm.tsx"
      provides: "Form orchestrator with FormProvider, section rendering, validation trigger on navigate"
      exports: ["GriForm"]
    - path: "src/components/gri/GriSidebar.tsx"
      provides: "Section navigation sidebar with completion indicators and click-to-jump"
      exports: ["GriSidebar"]
    - path: "src/components/gri/GriUniversalSection.tsx"
      provides: "GRI 2 General Disclosures form section with all 30 disclosures"
      exports: ["GriUniversalSection"]
    - path: "src/components/gri/GriMaterialTopics.tsx"
      provides: "GRI 3 materiality checklist + management approach disclosures"
      exports: ["GriMaterialTopics"]
    - path: "src/components/gri/GriTopicSection.tsx"
      provides: "Reusable Topic Standard section (renders disclosures for one topic)"
      exports: ["GriTopicSection"]
    - path: "src/components/gri/GriAssessment.tsx"
      provides: "Full-page resizable layout wrapping form and preview panels"
      exports: ["GriAssessment"]
    - path: "src/components/gri/GriReportPreview.tsx"
      provides: "Live HTML preview rendering formatted report from form values via useWatch"
      exports: ["GriReportPreview"]
  key_links:
    - from: "src/components/gri/GriForm.tsx"
      to: "src/schemas/gri.ts"
      via: "FormProvider with zodResolver(griSchema) and getDefaultValues()"
      pattern: "zodResolver.*griSchema"
    - from: "src/components/gri/GriReportPreview.tsx"
      to: "react-hook-form"
      via: "useWatch() subscribing to all form values for live preview"
      pattern: "useWatch"
    - from: "src/components/gri/GriAssessment.tsx"
      to: "src/components/ui/resizable.tsx"
      via: "ResizablePanelGroup with horizontal direction wrapping form and preview"
      pattern: "ResizablePanelGroup"
    - from: "src/pages/ModulePage.tsx"
      to: "src/components/gri/GriAssessment.tsx"
      via: "Conditional render: GRI slug shows GriAssessment, others show placeholder"
      pattern: "frameworkSlug.*gri.*GriAssessment"
    - from: "src/components/gri/GriForm.tsx"
      to: "src/hooks/useLocalStorageForm.ts"
      via: "useLocalStorageForm('gri-form-data') called inside FormProvider"
      pattern: "useLocalStorageForm"
---

<objective>
Build the complete GRI form UI, section navigation sidebar, materiality-driven Topic Standards, live report preview, and resizable split layout -- connecting all schema and infrastructure from Plan 01 into a working assessment experience.

Purpose: This is the core user-facing delivery for Phase 2. Students interact with the form (FORM-01), see their report take shape in real-time (FORM-07), and can navigate the complex GRI structure via a persistent sidebar. This plan proves the full assessment pattern that Phase 3 will replicate.

Output: A working GRI assessment page with form left / preview right in a draggable resizable layout, persistent sidebar navigation, materiality-driven topic sections, and localStorage persistence.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-gri-module-end-to-end/02-RESEARCH.md
@.planning/phases/02-gri-module-end-to-end/02-01-SUMMARY.md
@src/schemas/gri.ts
@src/components/shared/DisclosureField.tsx
@src/hooks/useLocalStorageForm.ts
@src/hooks/useGriCompletion.ts
@src/pages/ModulePage.tsx
@src/components/layout/AppLayout.tsx
@src/index.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GRI form components -- GriForm, GriSidebar, section components</name>
  <files>
    src/components/gri/GriForm.tsx
    src/components/gri/GriSidebar.tsx
    src/components/gri/GriUniversalSection.tsx
    src/components/gri/GriMaterialTopics.tsx
    src/components/gri/GriTopicSection.tsx
  </files>
  <action>
    **Install shadcn/ui Resizable** (needed in Task 2 but install now to avoid interruption):
    ```bash
    npx shadcn@latest add resizable --yes
    ```

    **Create `src/components/gri/GriForm.tsx`:**

    The form orchestrator. Responsibilities:
    - Initialize react-hook-form with `useForm<GriFormData>()`, zodResolver(griSchema), mode: "onSubmit" (validation on section submit per user decision, NOT onChange)
    - Load default values via `getDefaultValues()` (useLocalStorageForm handles hydration from storage)
    - Wrap content in FormProvider
    - Call `useLocalStorageForm("gri-form-data")` inside FormProvider for persistence
    - Track `activeSection` state (string, defaults to "gri2")
    - Render GriSidebar on the left, active section content on the right
    - On section navigate: call `trigger(sectionFieldNames)` to validate the departing section (per research Pattern: section validation on navigate). Show errors but do NOT block navigation (per user decision: validation surfaces errors but doesn't prevent navigation).
    - Include a "Validate All" button in the form header/toolbar that runs full schema validation
    - Include a placeholder for the PDF export button (Plan 03 will add the actual PDFDownloadLink)

    Active section rendering:
    - "gri1" -> Informational panel (GRI 1 Foundation is principles-only, no fields. Show a brief description: "GRI 1 establishes the reporting principles...")
    - "gri2" -> `<GriUniversalSection />`
    - "gri3" -> `<GriMaterialTopics />`
    - Any topic code (e.g., "305") -> `<GriTopicSection topicCode={activeSection} />`

    Form layout (within the left panel of the resizable split, which Task 2 creates):
    ```
    [GriSidebar (fixed width ~220px)] [Form Content (flex-1, scrollable)]
    ```

    **Create `src/components/gri/GriSidebar.tsx`:**

    Persistent sidebar listing all GRI sections. Per user decisions:
    - Always visible on the left side of the form panel
    - Lists: GRI 1 (Foundation), GRI 2 (General Disclosures), GRI 3 (Material Topics), then Topic Standard groups (Economic 200s, Environmental 300s, Social 400s)
    - Topic Standards only show in sidebar if they are in materialTopics (checked in GRI 3). Use useWatch on "materialTopics" field.
    - Click any section to navigate (sets activeSection)
    - Shows visual completion indicator per section. Use useGriCompletion() hook. Claude's discretion on indicator style: recommend a small progress bar or filled circle with percentage. Keep it subtle and professional (consulting-firm aesthetic).
    - Active section highlighted with primary color background
    - Use shadcn/ui ScrollArea for the sidebar content (can get long with many material topics)

    **Create `src/components/gri/GriUniversalSection.tsx`:**

    Renders all GRI 2 General Disclosures (2-1 through 2-30). Uses:
    - `griDisclosures.filter(d => d.section === "gri2")` to get disclosures
    - Groups by subsection (Organization, Activities, Governance, Strategy, Stakeholder Engagement) using the subsection ranges from the research
    - Renders each disclosure using `<DisclosureField>` from Plan 01
    - Each subsection has a heading (e.g., "The Organization") with a subtle separator
    - Uses `useFormContext()` for form access (NOT prop drilling)

    **Create `src/components/gri/GriMaterialTopics.tsx`:**

    Renders GRI 3 disclosures (3-1 through 3-3) PLUS the materiality checklist. Two parts:

    Part 1: GRI 3 Disclosures
    - 3-1: Process to determine material topics (textarea)
    - 3-2: List of material topics (textarea)
    - 3-3: Management of material topics (textarea)
    - Rendered using DisclosureField

    Part 2: Materiality Checklist
    - Header: "Select Material Topics"
    - Description: "Check the topics that are material to your organization. Selected topics will appear in the form for detailed disclosure."
    - Group by series (Economic, Environmental, Social) using topicStandardGroups
    - Each topic: shadcn/ui Checkbox + topic name (e.g., "GRI 305: Emissions")
    - Uses useFormContext() to read/write materialTopics array field
    - When checkbox toggled: add/remove topic code from materialTopics array using react-hook-form's setValue
    - Use shadcn/ui Accordion for collapsible groups (Economic, Environmental, Social)

    **Create `src/components/gri/GriTopicSection.tsx`:**

    Reusable component that renders all disclosures for one Topic Standard.

    Props: `{ topicCode: string }` (e.g., "305")

    Logic:
    - Filter griDisclosures for section === topicCode
    - Get topic name from griSections or topicStandardGroups
    - Render section header with topic name
    - Map each disclosure to DisclosureField
    - If no disclosures found for this topic code, show a message like "No specific disclosures defined for this standard. Use the management approach disclosure (GRI 3-3) to report on this topic."
  </action>
  <verify>
    <automated>npx tsc --noEmit 2>&1 | head -20</automated>
    <manual>Check that GriForm uses FormProvider + zodResolver, GriSidebar reads materialTopics via useWatch, GriMaterialTopics toggles materialTopics array, GriTopicSection renders disclosures filtered by topicCode.</manual>
  </verify>
  <done>
    - GriForm initializes react-hook-form with griSchema + zodResolver in onSubmit mode
    - GriSidebar navigates sections, shows completion indicators, and filters Topic Standards by materiality
    - GriUniversalSection renders all 30 GRI 2 disclosures grouped by subsection
    - GriMaterialTopics renders GRI 3 disclosures + materiality checklist with accordion groups
    - GriTopicSection renders disclosures for any given Topic Standard code
    - Validation triggers on section navigate but does not block navigation
    - Zero TypeScript errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Create resizable assessment layout, live report preview, and wire into ModulePage</name>
  <files>
    src/components/gri/GriAssessment.tsx
    src/components/gri/GriReportPreview.tsx
    src/pages/ModulePage.tsx
    src/components/layout/AppLayout.tsx
    src/components/ui/resizable.tsx
  </files>
  <action>
    **Create `src/components/gri/GriAssessment.tsx`:**

    The top-level layout wrapper for the GRI assessment. This component:
    - Wraps everything in a full-viewport-height container: `h-[calc(100vh-var(--nav-height,4rem))]`
    - Uses shadcn/ui ResizablePanelGroup (direction="horizontal") with ResizableHandle withHandle
    - Left panel (defaultSize={55} minSize={30}): Contains `<GriForm />`
    - Right panel (defaultSize={45} minSize={25}): Contains `<GriReportPreview />` wrapped in shadcn/ui ScrollArea
    - Per user decision: independent scrolling -- each panel scrolls independently
    - The ResizableHandle acts as the draggable divider per user decision

    Layout structure:
    ```
    [ResizablePanelGroup direction="horizontal" className="h-full"]
      [ResizablePanel defaultSize={55} minSize={30}]
        [GriForm]  // internally has sidebar + scrollable form content
      [/ResizablePanel]
      [ResizableHandle withHandle /]
      [ResizablePanel defaultSize={45} minSize={25}]
        [ScrollArea className="h-full"]
          [GriReportPreview /]
        [/ScrollArea]
      [/ResizablePanel]
    [/ResizablePanelGroup]
    ```

    **Create `src/components/gri/GriReportPreview.tsx`:**

    Live HTML preview of the GRI report. Per user decisions:
    - Renders as a formatted report document (headers, sections, Content Index)
    - Uses `useWatch()` from react-hook-form to subscribe to ALL form values -- this is the isolated re-render pattern from research Pattern 2. The preview re-renders when values change, but form fields don't re-render.
    - Also reads materialTopics to know which Topic Standards to include

    Preview structure:
    ```
    Report Title: "GRI Sustainability Report"
    (Organization name from disclosure 2-1 if filled, otherwise placeholder)

    Section: GRI 2 - General Disclosures
      Subsection: The Organization
        2-1: Organizational details -> [value or grayed placeholder]
        2-2: Entities included... -> [value or grayed placeholder]
        ...
      Subsection: Activities and Workers
        ...

    Section: GRI 3 - Material Topics
      3-1: Process to determine... -> [value or grayed placeholder]
      ...

    Section: Topic Standards
      (For each material topic, in order)
      GRI 305: Emissions
        305-1: Direct GHG emissions -> [value or grayed placeholder]
        ...

    Section: GRI Content Index
      Table with columns: Disclosure | Title | Status (Reported / Not reported)
    ```

    Styling:
    - Professional report formatting using Tailwind prose-like classes
    - Section headers: text-lg font-semibold with bottom border
    - Disclosure codes: text-xs text-muted-foreground
    - Empty/unfilled values: show grayed-out italic placeholder text (e.g., "[Organizational details will appear here]") per user decision
    - Filled values: normal text-foreground
    - Content Index: a table at the bottom listing all applicable disclosures with reported/not-reported status
    - Overall: white background, professional typography, matching the eventual PDF look

    **Update `src/pages/ModulePage.tsx`:**

    Conditional rendering based on framework slug:
    - If `frameworkSlug === "gri"`: render `<GriAssessment />` (the full resizable assessment layout)
    - For all other slugs: keep the existing intro + placeholder skeleton
    - The GRI assessment replaces the entire current content (no intro section above it -- the full viewport height is for the assessment)
    - Import GriAssessment lazily if desired, or directly

    **Update `src/components/layout/AppLayout.tsx`:**

    The current AppLayout wraps content in `max-w-7xl mx-auto px-4 py-8`. The GRI assessment needs full-width (no max-width constraint) and full-height (no padding).

    Approach: Make the layout conditionally full-width. Two options:
    1. Use a CSS class that the GRI route can toggle (e.g., via React Router outlet context)
    2. Move the max-width/padding into pages that need it, not the layout

    Recommended approach (simpler): Add a data attribute or class to control the main element:
    - Create an `AssessmentLayout` wrapper OR conditionally render layout based on route
    - Simplest: Keep TopNav in AppLayout. For the main element, check if current route is an assessment route. If so, render `<Outlet />` without the max-w-7xl wrapper. Otherwise, keep the wrapper.
    - Use `useLocation()` or `useParams()` to detect: if `frameworkSlug === "gri"` and assessment is active, use full-width layout.

    Alternative simpler approach: Just add a second route layout. In App.tsx routing:
    ```
    / -> AppLayout (with max-w-7xl) -> DashboardPage
    /module/:frameworkSlug -> AppLayout (with conditional layout) -> ModulePage
    ```

    The cleanest solution: ModulePage renders differently for GRI. When rendering GriAssessment, it returns a full-bleed component that breaks out of the max-w-7xl container. Use negative margins + full viewport width:
    ```
    className="-mx-4 sm:-mx-6 lg:-mx-8 -mb-8 -mt-0"
    ```
    OR better: update AppLayout to not apply padding/max-width when a `fullBleed` flag is set. Use Outlet context:
    ```tsx
    // AppLayout.tsx
    const [fullBleed, setFullBleed] = useState(false);
    <main className={fullBleed ? "" : "mx-auto max-w-7xl px-4 py-8 sm:px-6 lg:px-8"}>
      <Outlet context={{ setFullBleed }} />
    </main>
    ```
    ModulePage calls `setFullBleed(true)` when rendering GRI assessment.

    Use whichever approach is cleanest. The key requirement: GriAssessment must take the full viewport width and height below the TopNav, with no padding or max-width constraints.
  </action>
  <verify>
    <automated>npm run build 2>&1 | tail -5</automated>
    <manual>
      1. Run `npm run dev`
      2. Navigate to /module/gri
      3. Verify: full-width resizable layout with form left / preview right
      4. Verify: draggable divider between form and preview
      5. Verify: sidebar on left of form panel with GRI sections
      6. Verify: clicking sections navigates the form
      7. Verify: selecting material topics in GRI 3 adds them to sidebar and form
      8. Verify: typing in form fields updates the preview in real-time
      9. Verify: empty fields show grayed placeholder in preview
      10. Verify: both panels scroll independently
      11. Verify: navigating away from /module/gri and back preserves form data (localStorage)
      12. Verify: /module/issb still shows the old placeholder layout
    </manual>
  </verify>
  <done>
    - GRI module shows full-width resizable split layout with form left / preview right
    - Draggable divider with handle allows resizing panels
    - Sidebar lists all GRI sections with completion indicators; clicking navigates
    - Material topics checklist controls which Topic Standards appear in form and sidebar
    - Live preview renders formatted report updating in real-time as student types
    - Empty/unfilled disclosures show grayed placeholder text in preview
    - Preview includes a Content Index table showing reported/not-reported status
    - Form data persists to localStorage across browser sessions
    - Validation runs on section navigate (errors shown but navigation not blocked)
    - Other framework modules (/module/issb, etc.) still show original placeholder layout
    - Build succeeds with zero errors
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `npm run build` succeeds
2. `npx tsc --noEmit` passes
3. GRI assessment page renders at /module/gri with full-width resizable layout
4. Form has sidebar with all GRI sections + completion tracking
5. GRI 2 section shows 30 disclosure fields grouped by subsection
6. GRI 3 section shows 3 disclosure fields + materiality checklist
7. Selecting topics in checklist adds section to sidebar and form
8. Preview updates live as user types
9. localStorage persistence works (fill fields, refresh, data restored)
10. Other module pages unaffected
</verification>

<success_criteria>
- Students see a structured GRI form with sidebar navigation mirroring Universal Standards and Topic Standards
- Live preview renders a formatted report document in real-time
- Resizable split layout with draggable divider works
- Material topic selection drives conditional section rendering
- Form data persists across browser sessions
- The pattern is clearly structured for replication in Phase 3
</success_criteria>

<output>
After completion, create `.planning/phases/02-gri-module-end-to-end/02-02-SUMMARY.md`
</output>
