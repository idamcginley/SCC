---
phase: 02-gri-module-end-to-end
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/schemas/gri.ts
  - src/components/shared/DisclosureField.tsx
  - src/hooks/useLocalStorageForm.ts
  - src/hooks/useGriCompletion.ts
  - src/components/ui/field.tsx
  - src/components/ui/checkbox.tsx
  - src/components/ui/scroll-area.tsx
  - src/components/ui/accordion.tsx
autonomous: true
requirements:
  - FORM-06
  - ACCU-01

must_haves:
  truths:
    - "GRI Zod schema defines all GRI 2 General Disclosures (2-1 through 2-30), GRI 3 Material Topics (3-1 through 3-3), and all Topic Standards (201 through 419)"
    - "Each disclosure in the metadata array has a code, label, section, fieldType, and required flag"
    - "Zod schema validates material topic disclosures conditionally (only required when topic is selected)"
    - "DisclosureField renders correct input type (textarea, text, number, select) based on fieldType metadata"
    - "useLocalStorageForm persists form values with debounced writes and hydrates on mount"
  artifacts:
    - path: "src/schemas/gri.ts"
      provides: "GRI Zod schema, GriFormData type, griDisclosures metadata array, GriSection type"
      exports: ["griSchema", "griDisclosures", "GriFormData", "GriSection", "getDefaultValues"]
    - path: "src/components/shared/DisclosureField.tsx"
      provides: "Generic disclosure field renderer using react-hook-form Controller + shadcn/ui Field"
      exports: ["DisclosureField"]
    - path: "src/hooks/useLocalStorageForm.ts"
      provides: "Debounced localStorage persistence hook for react-hook-form"
      exports: ["useLocalStorageForm"]
    - path: "src/hooks/useGriCompletion.ts"
      provides: "Section completion percentage calculator using useWatch"
      exports: ["useGriCompletion"]
  key_links:
    - from: "src/schemas/gri.ts"
      to: "zod"
      via: "z.object schema definition with superRefine for materiality validation"
      pattern: "z\\.object|superRefine"
    - from: "src/components/shared/DisclosureField.tsx"
      to: "src/schemas/gri.ts"
      via: "uses DisclosureDefinition type for field metadata"
      pattern: "DisclosureDefinition"
    - from: "src/hooks/useLocalStorageForm.ts"
      to: "react-hook-form"
      via: "useWatch + useFormContext for value observation and form reset"
      pattern: "useWatch|useFormContext"
---

<objective>
Create the GRI data schema and shared form infrastructure that all subsequent plans depend on.

Purpose: Establish the single source of truth for GRI disclosure structure (Zod schema + metadata array) and the reusable infrastructure (DisclosureField, localStorage persistence, completion tracking) that the form UI, preview, and PDF all consume. This is the foundation that proves framework accuracy (ACCU-01) and enables validation (FORM-06).

Output: GRI Zod schema with full disclosure metadata, shared DisclosureField component, useLocalStorageForm hook, useGriCompletion hook, plus shadcn/ui Field/Checkbox/ScrollArea/Accordion components installed.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-gri-module-end-to-end/02-RESEARCH.md
@src/data/frameworks.ts
@src/lib/utils.ts
@src/components/ui/input.tsx
@src/components/ui/textarea.tsx
@src/components/ui/label.tsx
@src/components/ui/select.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create GRI Zod schema with disclosure metadata</name>
  <files>
    src/schemas/gri.ts
    src/components/ui/field.tsx
    src/components/ui/checkbox.tsx
    src/components/ui/scroll-area.tsx
    src/components/ui/accordion.tsx
    package.json
  </files>
  <action>
    **Step 1: Install npm dependencies**
    ```bash
    npm install react-hook-form zod @hookform/resolvers @react-pdf/renderer
    ```

    **Step 2: Install shadcn/ui components**
    ```bash
    npx shadcn@latest add field checkbox scroll-area accordion --yes
    ```
    Note: The `field` component is the NEW shadcn/ui form field system (FieldLabel, FieldError, FieldDescription). Do NOT use the deprecated `Form`/`FormField`/`FormItem` components. If the shadcn CLI installs a `form.tsx` instead of `field.tsx`, check `npx shadcn@latest add --help` for correct component name. The field component should export: Field, FieldLabel, FieldError, FieldDescription.

    **Step 3: Create `src/schemas/gri.ts`**

    This file is the single source of truth for all GRI disclosure structure. It must contain:

    1. **Type definitions:**
       - `FieldType = "textarea" | "text" | "number" | "select" | "boolean"`
       - `GriSection = "gri1" | "gri2" | "gri3" | string` (string for topic codes like "201", "305")
       - `DisclosureDefinition` interface with: code, label, section, fieldType, required, options?, unit?
       - `GriSectionMeta` interface with: id (GriSection), name, description

    2. **Section metadata array (`griSections`):**
       Define all sections in order:
       - gri1: "GRI 1: Foundation 2021" (no disclosure fields -- intro/principles only)
       - gri2: "GRI 2: General Disclosures 2021" -- 5 subsections:
         - The Organization (2-1 to 2-5)
         - Activities and Workers (2-6 to 2-8)
         - Governance (2-9 to 2-21)
         - Strategy, Policies, Practices (2-22 to 2-28)
         - Stakeholder Engagement (2-29 to 2-30)
       - gri3: "GRI 3: Material Topics 2021" (3-1 to 3-3)
       - Topic Standards sections: one per standard (201, 202, ..., 419)

    3. **Disclosure metadata array (`griDisclosures`):**
       ALL GRI disclosures. Per the research:
       - GRI 2: 30 disclosures (2-1 through 2-30), all required, mostly textarea
       - GRI 3: 3 disclosures (3-1 through 3-3), all required, textarea
       - Topic Standards (~82 disclosures across 33 standards), all NOT required (materiality-gated)

       Mixed field types per user decision:
       - Narrative disclosures: textarea
       - Quantitative disclosures: number + unit. Key quantitative standards:
         - GRI 302 Energy: number (GJ)
         - GRI 303 Water: number (ML)
         - GRI 305 Emissions: number (tCO2e)
         - GRI 306 Waste: number (metric tonnes)
         - GRI 401 Employment: number (count/rate)
         - GRI 403 OHS: number (rate/count)
         - GRI 405 Diversity: number (%)
       - Some disclosures with fixed options: select (e.g., GRI 2-7 employee type breakdown)

       **Label format:** Each disclosure label follows "GRI {code}: {title}" pattern, showing the GRI reference code per user decision (label + reference code only, no detailed guidance).

    4. **Topic Standards grouping (`topicStandardGroups`):**
       ```typescript
       export const topicStandardGroups = [
         { name: "Economic", series: "200", standards: ["201", "202", "203", "204", "205", "206", "207"] },
         { name: "Environmental", series: "300", standards: ["301", "302", "303", "304", "305", "306", "307", "308"] },
         { name: "Social", series: "400", standards: ["401", "402", "403", "404", "405", "406", "407", "408", "409", "410", "411", "412", "413", "414", "415", "416", "417", "418", "419"] },
       ];
       ```

    5. **Zod schema (`griSchema`):**
       Build from disclosure metadata. Structure:
       ```typescript
       const griSchema = z.object({
         gri2: z.object({ /* keyed by disclosure code with underscores: disclosure_2_1, etc */ }),
         gri3: z.object({ /* 3-1, 3-2, 3-3 */ }),
         materialTopics: z.array(z.string()).default([]),
         topics: z.object({ /* one optional nested object per topic standard */ }),
       }).superRefine((data, ctx) => {
         // Validate that material topics have at least some required disclosures filled
       });
       ```
       - Use `z.string().min(1, "Required")` for required textareas
       - Use `z.coerce.number().positive()` for required number fields
       - Use `z.string().optional().default("")` for non-required textareas
       - Topic Standard disclosure objects are `.optional()` at the topic level

    6. **Inferred type and default values:**
       ```typescript
       export type GriFormData = z.infer<typeof griSchema>;
       export function getDefaultValues(): GriFormData { /* empty defaults for all fields */ }
       ```

    **Important sizing note:** This file will be large (~400-600 lines) because it enumerates all GRI disclosures. This is intentional -- it's the single source of truth that drives both the form UI and PDF rendering. Do not try to abbreviate or skip disclosures; include all of them as documented in the research.
  </action>
  <verify>
    <automated>npx tsc --noEmit 2>&1 | head -20</automated>
    <manual>Check src/schemas/gri.ts exports griSchema, griDisclosures, GriFormData, getDefaultValues. Verify disclosure count: should have 30 GRI 2 disclosures + 3 GRI 3 disclosures + ~82 topic disclosures in griDisclosures array.</manual>
  </verify>
  <done>
    - GRI Zod schema compiles with zero TypeScript errors
    - griDisclosures array contains all GRI 2 (30), GRI 3 (3), and Topic Standard (~82) disclosures with correct codes, labels, sections, and field types
    - react-hook-form, zod, @hookform/resolvers, @react-pdf/renderer installed in package.json
    - shadcn/ui field, checkbox, scroll-area, accordion components installed
    - Quantitative disclosures (emissions, energy, water, waste) use number fieldType with appropriate units
  </done>
</task>

<task type="auto">
  <name>Task 2: Create DisclosureField, useLocalStorageForm, and useGriCompletion</name>
  <files>
    src/components/shared/DisclosureField.tsx
    src/hooks/useLocalStorageForm.ts
    src/hooks/useGriCompletion.ts
  </files>
  <action>
    **Step 1: Create `src/components/shared/DisclosureField.tsx`**

    A generic disclosure field renderer that reads metadata and renders the correct input. Uses react-hook-form Controller + shadcn/ui Field components (NOT the deprecated Form/FormField).

    Props interface:
    ```typescript
    interface DisclosureFieldProps {
      name: string;           // form field path (e.g., "gri2.disclosure_2_1")
      code: string;           // GRI code (e.g., "2-1")
      label: string;          // disclosure title
      fieldType: FieldType;   // from schema
      required?: boolean;
      options?: string[];     // for select fields
      unit?: string;          // for number fields (e.g., "tCO2e")
    }
    ```

    Rendering logic:
    - `textarea` -> shadcn/ui Textarea with 4 rows default
    - `text` -> shadcn/ui Input type="text"
    - `number` -> shadcn/ui Input type="number" with unit suffix label (e.g., "tCO2e")
    - `select` -> shadcn/ui Select with provided options
    - `boolean` -> shadcn/ui Checkbox

    Label format: GRI reference code in small muted text above the disclosure title. Example:
    ```
    GRI 2-1            <- text-xs text-muted-foreground
    Organizational details   <- FieldLabel text
    ```

    Error display: Use FieldError from shadcn/ui field component for validation errors.

    **Step 2: Create `src/hooks/useLocalStorageForm.ts`**

    Custom hook that persists react-hook-form values to localStorage with debounced writes. Per research Pattern 4:
    - Storage key parameterized: `useLocalStorageForm(key: string)` so each framework gets its own key
    - Debounce: 1000ms (1 second) -- per Claude's discretion on timing
    - Uses useWatch() for value observation
    - Uses useFormContext().reset() for hydration on mount
    - Wraps localStorage.setItem in try/catch per Pitfall 4 (quota handling)
    - On hydration failure (corrupt JSON), removes the key and continues with defaults
    - Returns `{ clearSavedData }` function for explicit clear action

    **Step 3: Create `src/hooks/useGriCompletion.ts`**

    Hook that calculates completion percentage per GRI section using useWatch. Returns a map of section -> completion percentage.

    Logic:
    - For each section, count how many disclosure fields have non-empty values
    - Completion = filledFields / totalFieldsInSection * 100
    - For topic standards: only count sections that are in materialTopics
    - Uses useWatch with specific field names to avoid full-form subscription where possible
    - Returns: `Record<string, number>` mapping section id to 0-100 percentage

    Export: `useGriCompletion()`
  </action>
  <verify>
    <automated>npx tsc --noEmit 2>&1 | head -20</automated>
    <manual>Verify DisclosureField renders different input types based on fieldType prop. Verify useLocalStorageForm debounces writes. Verify useGriCompletion returns section percentages.</manual>
  </verify>
  <done>
    - DisclosureField renders textarea, text, number (with unit), select, and boolean inputs based on fieldType
    - DisclosureField shows GRI reference code and disclosure label using shadcn/ui Field + FieldLabel + FieldError
    - useLocalStorageForm persists to localStorage with 1s debounce and hydrates on mount with error recovery
    - useGriCompletion returns section completion percentages respecting materiality selection
    - All three files compile with zero TypeScript errors
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `npx tsc --noEmit` passes with zero errors
2. `npm run build` succeeds
3. src/schemas/gri.ts exports: griSchema, griDisclosures, GriFormData, GriSection, getDefaultValues, griSections, topicStandardGroups
4. griDisclosures.length >= 115 (30 + 3 + ~82 topic disclosures)
5. All new shadcn/ui components (field, checkbox, scroll-area, accordion) exist in src/components/ui/
6. react-hook-form, zod, @hookform/resolvers are in package.json dependencies
</verification>

<success_criteria>
- GRI schema is the single source of truth with all disclosure metadata
- Schema validation correctly handles conditional materiality (material topics must have disclosures, non-material topics are optional)
- Shared infrastructure (DisclosureField, hooks) is framework-agnostic and reusable for Phase 3
- Zero TypeScript compilation errors
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/02-gri-module-end-to-end/02-01-SUMMARY.md`
</output>
